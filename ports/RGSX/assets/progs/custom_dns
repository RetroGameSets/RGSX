#!/bin/bash
# BATOCERA SERVICE
# name: Custom DNS Service for RGSX
# description: Force custom DNS servers (Cloudflare 1.1.1.1)
# author: RetroGameSets
# depends: 
# version: 1.0

RESOLV_CONF="/tmp/resolv.conf"
PIDFILE="/var/run/custom_dns.pid"
LOGFILE="/userdata/roms/ports/RGSX/logs/custom_dns_service.log"
SERVICE_NAME="custom_dns"

# Fonction utilitaire : vérifie si le service est activé dans batocera-settings
is_enabled() {
    local enabled_services
    enabled_services="$(/usr/bin/batocera-settings-get system.services 2>/dev/null)"
    for s in $enabled_services; do
        if [ "$s" = "$SERVICE_NAME" ]; then
            echo "enabled"
            return
        fi
    done
    echo "disabled"
}

# Fonction pour appliquer les DNS personnalisés
apply_custom_dns() {
    echo "[${SERVICE_NAME}] Applying custom DNS servers..."
    mkdir -p "$(dirname "$LOGFILE")"
    {
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Applying custom DNS"
        # Retirer la protection si elle existe
        chattr -i "$RESOLV_CONF" 2>/dev/null || true
        # Écrire la nouvelle configuration DNS
        echo "# Generated by RGSX Custom DNS Service" > "$RESOLV_CONF"
        echo "nameserver 1.1.1.1" >> "$RESOLV_CONF"
        echo "nameserver 1.0.0.1" >> "$RESOLV_CONF"
        # Protéger le fichier contre les modifications
        chattr +i "$RESOLV_CONF" 2>/dev/null || true
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Custom DNS applied successfully"
    } >> "$LOGFILE" 2>&1
    echo "[${SERVICE_NAME}] Custom DNS applied (1.1.1.1, 1.0.0.1)"
}

# Fonction pour restaurer les DNS par défaut
restore_default_dns() {
    echo "[${SERVICE_NAME}] Restoring default DNS..."
    mkdir -p "$(dirname "$LOGFILE")"
    {
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Restoring default DNS"
        # Retirer la protection
        chattr -i "$RESOLV_CONF" 2>/dev/null || true
        echo "$(date '+%Y-%m-%d %H:%M:%S') - DNS protection removed"
    } >> "$LOGFILE" 2>&1
    echo "[${SERVICE_NAME}] Default DNS restored"
}

case "$1" in
    start)
        if [ -f "$PIDFILE" ]; then
            echo "[${SERVICE_NAME}] Already running (PID $(cat "$PIDFILE"))"
            exit 0
        fi
        apply_custom_dns
        echo $$ > "$PIDFILE"
        echo "[${SERVICE_NAME}] Started (PID $(cat "$PIDFILE"))"
        ;;
        
    stop)
        if [ -f "$PIDFILE" ]; then
            echo "[${SERVICE_NAME}] Stopping..."
            restore_default_dns
            rm -f "$PIDFILE"
            echo "[${SERVICE_NAME}] Stopped"
        else
            echo "[${SERVICE_NAME}] Not running"
        fi
        ;;
        
    restart)
        echo "[${SERVICE_NAME}] Restarting..."
        "$0" stop
        sleep 1
        "$0" start
        ;;
        
    status)
        ENABLE_STATE=$(is_enabled)
        if [ -f "$PIDFILE" ]; then
            if chattr -i "$RESOLV_CONF" 2>/dev/null; then
                chattr +i "$RESOLV_CONF" 2>/dev/null
                echo "[${SERVICE_NAME}] Running (DNS protected) - ${ENABLE_STATE} on boot"
                exit 0
            else
                echo "[${SERVICE_NAME}] Running (DNS not protected) - ${ENABLE_STATE} on boot"
                exit 0
            fi
        else
            echo "[${SERVICE_NAME}] Not running - ${ENABLE_STATE} on boot"
            exit 1
        fi
        ;;
        
    enable)
        current=$(/usr/bin/batocera-settings-get system.services 2>/dev/null)
        if echo "$current" | grep -qw "$SERVICE_NAME"; then
            echo "[${SERVICE_NAME}] Already enabled on boot"
        else
            new_value="$current $SERVICE_NAME"
            /usr/bin/batocera-settings-set system.services "$new_value"
            echo "[${SERVICE_NAME}] Enabled on boot"
        fi
        ;;
        
    disable)
        current=$(/usr/bin/batocera-settings-get system.services 2>/dev/null)
        if echo "$current" | grep -qw "$SERVICE_NAME"; then
            new_value=$(echo "$current" | sed "s/\b$SERVICE_NAME\b//g" | xargs)
            /usr/bin/batocera-settings-set system.services "$new_value"
            echo "[${SERVICE_NAME}] Disabled on boot"
        else
            echo "[${SERVICE_NAME}] Already disabled"
        fi
        ;;
        
    *)
        echo "Usage: $0 {start|stop|restart|status|enable|disable}"
        exit 1
        ;;
esac

exit 0