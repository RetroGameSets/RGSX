# Pour dÃ©clencher ce workflow : git tag v1.X.X && git push origin v1.X.X
# OU en une seule ligne : git tag v1.X.X && git push origin --tags
name: Release on tag

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build RGSX Release Package
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME}"
          mkdir -p dist
          
          echo "Building RGSX package from ports/RGSX/ directoryâ€¦"
          cd ports/RGSX
          
          zip -r "../../dist/RGSX_${VERSION}.zip" . \
            -x "logs/*" \
               "logs/**" \
               "images/*" \
               "images/**" \
               "games/*" \
               "games/**" \
               "scripts/*" \
               "scripts/**" \
               "__pycache__/*" \
               "__pycache__/**" \
               "*.pyc" \
               "sources.json" \
               "*.log"
          
          cd ../..
          
          echo "Creating stable-named copy for latest download linkâ€¦"
          cp -f "dist/RGSX_${VERSION}.zip" "dist/RGSX_latest.zip"
          
          echo "âœ“ RGSX package created successfully"
          
          echo ""
          echo "Building RGSX Retrobat package (includes ports/ and windows/ directories)â€¦"
          zip -r "dist/RGSX_Retrobat_${VERSION}.zip" ports windows \
            -x "ports/RGSX/logs/*" \
               "ports/RGSX/logs/**" \
               "ports/RGSX/images/*" \
               "ports/RGSX/images/**" \
               "ports/RGSX/games/*" \
               "ports/RGSX/games/**" \
               "ports/RGSX/scripts/*" \
               "ports/RGSX/scripts/**" \
               "ports/RGSX/__pycache__/*" \
               "ports/RGSX/__pycache__/**" \
               "ports/RGSX/*.pyc" \
               "ports/RGSX/sources.json" \
               "ports/RGSX/*.log" \
               "windows/logs/*" \
               "windows/*.xml" \
               "ports/*.xml" \
               "*.xml" \
               "*.pyc" \
               "*.xml" \
               "*.log"
          
          echo "Creating stable-named copy for Retrobat packageâ€¦"
          cp -f "dist/RGSX_Retrobat_${VERSION}.zip" "dist/RGSX_Retrobat_latest.zip"
          
          echo "âœ“ All packages created successfully"
          ls -lh dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: RGSX ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## ðŸ“¦ RGSX Release ${{ github.ref_name }}
            
            ### ðŸ“¥ Installation
            
            #### Pour Batocera/Knulli/Linux
            1. TÃ©lÃ©chargez `RGSX_${{ github.ref_name }}.zip`
            2. Extrayez le contenu dans `/userdata/roms/ports/RGSX/`
            3. Lancez RGSX depuis le menu Ports
            
            #### Pour Retrobat/Windows
            1. TÃ©lÃ©chargez `RGSX_Retrobat_${{ github.ref_name }}.zip`
            2. Extrayez le contenu Ã  la racine de Retrobat (les dossiers `ports/` et `windows/` seront crÃ©Ã©s automatiquement)
            3. Lancez RGSX depuis le menu Ports ou exÃ©cutez `RGSX Retrobat.bat`
            
            ### ðŸ“¦ Contenu des packages
            
            **RGSX_${{ github.ref_name }}.zip** (Batocera/Knulli/Linux)
            - Application RGSX complÃ¨te (tous les fichiers Python)
            - Interface graphique pygame
            - Interface web (rgsx_web.py)
            - Assets complets (polices, images SVG, musiques, utilitaires)
            - Mappings de contrÃ´leurs
            - Traductions (FR, EN, ES, DE, IT, PT)
            - Script de lancement (RGSX.sh)
            
            **RGSX_Retrobat_${{ github.ref_name }}.zip** (Windows/Retrobat)
            - Tout le contenu du package standard
            - Structure de dossiers `ports/` et `windows/` pour Retrobat
            - Scripts batch Windows
            - Fichiers gamelist.xml prÃ©configurÃ©s
            - VidÃ©os et images pour l'interface Retrobat
            
            ### ðŸ“– Documentation
            Consultez le [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) pour plus d'informations.
          files: |
            dist/RGSX_${{ github.ref_name }}.zip
            dist/RGSX_latest.zip
            dist/RGSX_Retrobat_${{ github.ref_name }}.zip
            dist/RGSX_Retrobat_latest.zip
            dist/RGSX_latest.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
